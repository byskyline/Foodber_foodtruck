<!DOCTYPE html>
<html lang="en">
<head>
  <title>Foodber</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

</head>
<body>
<h1>Foodber</h1>

<p><%= image_tag "logo.png", size: "1100x600" %></p>


<!--  Google Map Start -->

 <div id="map" style="height: 450px;"></div>
  <script type="text/javascript">

    var map;
    var Taipei = {lat: 25.0638929, lng: 121.547199};
    
    var image_dragon = { 
      url: '<%= asset_path('dragon.png') %>'
    };

    var marker_dragon;
    var infoWindow;
    var current_pos;

    var contentString;

    var food_truck_infowindow;

    function initMap() {

      var directionsService = new google.maps.DirectionsService;
      var directionsDisplay = new google.maps.DirectionsRenderer;

      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13
      });

      directionsDisplay.setMap(map);

      var truck_image = { 
        url: '<%= asset_path('Food Truck.png') %>'
      };

      var marker = new google.maps.Marker({
        position: Taipei,
        map: map,
        icon: truck_image
      });


      food_truck_infowindow = new google.maps.InfoWindow({
      });

      marker.addListener('click', function() {

        calculateAndDisplayRoute(directionsService, directionsDisplay);

        food_truck_infowindow.open(map, marker);

      });

      //Your location marker new
      marker_dragon = new google.maps.Marker({
      });

      infoWindow = new google.maps.InfoWindow({
        pixelOffset: new google.maps.Size(10, -65),
      });

      // Try HTML5 geolocation.

      if (navigator.geolocation) {

        var options = {frequency: 1000};

        navigator.geolocation.watchPosition(function(position) {

          current_pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          marker_dragon.setOptions({
            map: map,
            position: current_pos,
            icon: image_dragon
            
          });

          infoWindow.setOptions({
            map: map,
            position: current_pos
          });
          infoWindow.setPosition(current_pos);
          infoWindow.setContent('You R Here.');
          map.setCenter(current_pos);

          $.ajax({

            type: "POST",

            url:"http://localhost:3000/food_truck_positions",

            data: { food_truck_position: current_pos },// product: { name: "Filip", description: "whatever" }

            success: function(data, textStatus, jqXHR) {

            },
            // error: function(jqXHR, textStatus, errorThrown) {
            //   alert("Error=" + errorThrown);
            // }
          });

        }, function(){
         handleLocationError(true, infoWindow, map.getCenter());
       }, {frequency: 1000});
} 
else{
        // Browser doesn't support Geolocation
        handleLocationError(false, infoWindow, map.getCenter());
      }

    }

    function calculateAndDisplayRoute(directionsService, directionsDisplay) {
      directionsService.route({
       origin: Taipei,
       destination: current_pos ,
       travelMode: google.maps.TravelMode.DRIVING
     }, function(response, status) {
       if (status === google.maps.DirectionsStatus.OK) {

        contentString = '<div id="content">'+
        "Hi~I'm a Food Truck"+
        '</div>';

        console.log( response.routes[0].legs[0].distance.value );

        contentString += "約 " + (response.routes[0].legs[0].distance.value)/1000 + " 公里" + "</br>";
        contentString += "約 " + (response.routes[0].legs[0].duration.value)/60 + " 分鐘";

        directionsDisplay.setOptions( { suppressMarkers: true } );
        directionsDisplay.setDirections(response);

        food_truck_infowindow.setOptions({
          content: contentString
        });

      } else {
       window.alert('Directions request failed due to ' + status);
     }
   });
    }

  </script>
  <script async defer
  src="https://maps.googleapis.com/maps/api/js?region=cn&language=zh-TW&key=AIzaSyDDHzZHU1KEDq_t_rClDOTK7YEWHU1FloE&callback=initMap">
</script>

<!--  Google Map End -->

<table class="table">

    <tr>
      <td>餐車名稱</td>
      <td>Longitude</td>
      <td>Latitude</td>
      <td>餐車圖片</td>
      <td>餐車餐點詳細內容</td>
      <td>其他功能</td>
    </tr>


  <tr>
    <% @food_trucks.each do |f| %>

        <td><%= f.name %></td>
        <td><%= f.longitude %></td>
        <td><%= f.latitude %></td>
        <td>
         <% if f.picture.exists? %>
          <%= image_tag(f.picture.url(:medium))%>
         <% else %>
          None
         <% end %>
        </td>
        <td><%= link_to '更多詳情', food_truck_foods_path(f)%></td>
        <td><%= link_to 'Show', food_truck_path(f) , :class=> "btn btn-primary"%></td>
        <td><%= link_to 'Edit', edit_food_truck_path(f), :class=> "btn btn-default" %></td>
        <td><%= link_to 'Destroy', f, method: :delete, data: { confirm: 'Are you sure?' }, :class=> "btn btn-danger" %></td>
      </tr>
    <% end %>

</table>

<br>

<p><%= link_to '新增餐車', new_food_truck_path,:class=>"btn btn-primary" %></p>


  <ul class="pagination">

    <li><a href=" <%=paginate @food_trucks %>"></a></li>

  </ul>

<%= paginate @food_trucks %>

</body>
</html>
